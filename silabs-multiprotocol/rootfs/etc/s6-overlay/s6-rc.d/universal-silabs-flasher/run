#!/usr/bin/with-contenv bashio
# ==============================================================================
# Start universal-silabs-flasher if requested
# ==============================================================================

declare autoflash_firmware
declare device
declare baudrate
declare firmware
declare usb_device_path
declare usb_manufacturer
declare usb_product

device=$(bashio::config 'device')
baudrate=$(bashio::config 'baudrate')

if ! bashio::config.true 'autoflash_firmware'; then
    s6-svc -d /run/service/universal-silabs-flasher
fi

# Check device manufacturer/product information
usb_device_path=$(realpath /sys/class/tty/$(readlink /sys/class/tty/$(basename ${device}))/../../../../)
if [ ! -f "${usb_device_path}/idProduct" ]; then
    bashio::log.warning "The serial port seems not to be a USB device"
    s6-svc -d /run/service/universal-silabs-flasher
fi
usb_manufacturer=$(cat "${usb_device_path}/manufacturer")
usb_product=$(cat "${usb_device_path}/product")

bashio::log.info "Checking ${device} identifying ${usb_product} from ${usb_manufacturer}"
if [[ "${usb_manufacturer}" == "Nabu Casa" && "${usb_product}" == "SkyConnect"* ]]; then
    firmware="NabuCasa_SkyConnect_RCP_v4.1.3_rcp-uart-hw-802154_115200.gbl"
else
    bashio::log.info "No valid firmware for this device"
    s6-svc -d /run/service/universal-silabs-flasher
fi


bashio::log.info "Starting universal-silabs-flasher with ${device} (baudrate ${baudrate})"
exec universal-silabs-flasher --device ${device} --baudrate ${baudrate} \
     --bootloader-baudrate 115200 \
     flash --firmware "/root/${firmware}"
